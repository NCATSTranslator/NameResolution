# Deployment

## Setting up NameRes locally

NameRes requires an Apache Solr database and the NameRes frontend running in Python.
The easiest way to set this up is by using the Docker Compose setup included in this
file, although you will need either (1) a set of synonyms files generated by Babel
to load into Solr, or (2) a Solr database backup to load into Solr. The following
instructions will work whichever of the two approaches you need to follow.

### Starting NameRes locally by loading a Solr backup

The simplest way to run NameRes locally is by using a Solr backup from another NameRes
instance or from Translator.

1. Make sure you have [Docker](https://www.docker.com/) installed; this should come
   with [Docker Compose](https://docs.docker.com/compose/install/).
2. Create the local directory where your Solr data will be stored -- by default, this is
   `./data/solr` in this directory, but you can change this in
   [docker-compose.yml](./docker-compose.yml). This directory will need approximately 250G
   of storage: ~100G for the downloaded backup file (which can be deleted once extracted)
   and ~150G for the extracted Solr core directory.
3. Download the Solr backup URL you want to use and save it in `./data/solr`. It should be
   approximately 100G in size.
4. Extract the Solr backup into `./data/solr`:
   ```
   cd ./data/solr && tar zxvf solr-data.tar.gz
   ```
   This produces a `name_lookup/` directory (the complete Solr core, including schema and
   index data). You can delete the downloaded file (`solr-data.tar.gz`) once it has been
   extracted.
5. Check the [docker-compose.yml](./docker-compose.yml) file to ensure that it is
   as you expect.
    * The Docker Compose file will use the latest released version of NameRes
      as the frontend. To use the source code in this repository, you will need to change
      the build instructions for the `nameres` service in the Docker Compose file.
    * Solr will be given 16G of memory, which seems sufficient for testing.
      If you want to run many Solr queries, you might want to increase this. To do this,
      you will need to change BOTH the `mem_limit` setting in the `nameres_solr` service in
      `docker-compose.yml` and the `SOLR_JAVA_MEM` setting.
    * The `docker-compose.yml` file also mounts the local `data/solr` directory into the Solr
      container as `/var/solr/data`. This will allow you to start a new NameRes from the same
      directory in the future. If you want to use a different directory, please change
      the `volumes` setting in the `nameres_solr` service in `docker-compose.yml`. Removing
      the binding will cause the Solr data to be stored in the Docker instance, and the
      data will be lost when the container is stopped.
6. Start the Solr and NameRes pods by running `docker compose up`. By default, Docker Compose
   will download and start the relevant pods and show you logs from both sources. Solr will
   find the extracted `name_lookup/` core and be ready immediately — no separate restore step
   is required. You may press `Ctrl+C` to stop the pods.
7. With the default settings, NameRes should be running on localhost on port 2433 (i.e. http://localhost:2433/).
   Look up http://localhost:2433/status to confirm that the database has been loaded as expected.
   You should see a message in the NameRes pod log saying something like
   `Uvicorn running on http://0.0.0.0:2433 (Press CTRL+C to quit)` to confirm this.
   * By default, the web frontend (http://0.0.0.0:2433/docs) defaults to using the
     [NameRes RENCI Dev](https://name-resolution-sri.renci.org/docs) — you will need to
     change the "Servers" setting to use your local NameRes instance.

#### Loading from synonyms files

The best way to do this is by using the [data-loading Docker image](./data-loading/README.md).

### Python packaging

Currently, NameRes is only packaged as a Docker image (see [Dockerfile](./Dockerfile)), but you can
also run it directly via Uvicorn.

```bash
$ python -m venv venv
$ source venv/bin/activate
$ pip install -r requirements.txt
$ bash main.sh
```

### Kubernetes

Helm charts can be found at https://github.com/helxplatform/translator-devops/helm/name-lookup.

## examples

```bash
curl -X POST "http://localhost:2433/lookup?string=oxycod&offset=0&limit=10" -H "accept: application/json"
```

## Configuration

NameRes can be configured by setting environmental variables:

* `SOLR_HOST` and `SOLR_PORT`: Hostname and port for the Solr database containing NameRes information.
* `SERVER_NAME`: The name of this server (defaults to `infores:sri-name-resolver`)
* `SERVER_ROOT`: The server root (defaults to `/`)
* `MATURITY_VALUE`: How mature is this NameRes (defaults to `maturity`, e.g. `development`)
* `LOCATION_VALUE`: Where is this NameRes setup (defaults to `location`, e.g. `RENCI`)
* `OTEL_ENABLED`: Turn on Open TELemetry (default: `'false'`) -- only `'true'` will turn this on.
    * `JAEGER_HOST` and `JAEGER_PORT`: Hostname and port for the Jaegar instance to provide telemetry to.
    * `JAEGER_SERVICE_NAME`: The name of this service (defaults to the value of `SERVER_NAME`)
